<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BPLD Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; margin:0; padding:0; font-family:'Roboto', sans-serif; }
body { background:#f4f7fc; padding:20px; }

/* Navbar */
.navbar {
  width:100%;
  background:#093d75;
  color:white;
  padding:15px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-radius:10px;
  flex-wrap:wrap;
}
.navbar h2 { font-weight:500; font-size:18px; }
.navbar button {
  background:#dc3545;
  border:none;
  padding:8px 14px;
  border-radius:6px;
  cursor:pointer;
  color:white;
  transition:0.3s;
}
.navbar button:hover{ background:#a71d2a; }

/* Dashboard Top */
.dashboard-top {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:20px;
  flex-wrap:wrap;
  gap:15px;
}
.dashboard-top .welcome, .dashboard-top .receiving {
  background:white;
  padding:20px;
  border-radius:12px;
  box-shadow:0 8px 20px rgba(0,0,0,0.1);
}
.dashboard-top .receiving { text-align:center; transition:0.3s; cursor:pointer; }
.dashboard-top .receiving:hover { transform:translateY(-3px); box-shadow:0 12px 25px rgba(0,0,0,0.15); }
.dashboard-top button { background:#007bff; color:white; border:none; border-radius:8px; padding:12px; cursor:pointer; width:100%; font-size:16px; transition:0.3s; }
.dashboard-top button:hover{ background:#0056b3; }

/* Table */
.table-container { margin-top:30px; overflow-x:auto; }
table {
  width:100%;
  border-collapse:collapse;
  border-radius:8px;
  background:white;
  box-shadow:0 5px 15px rgba(0,0,0,0.1);
}
th, td { padding:12px; border-bottom:1px solid #e0e0e0; text-align:left; }
thead{ background:#093d75; color:white; }
tr.pending { background:#fff3cd; cursor:pointer; transition:0.2s; }
tr.pending:hover { background:#ffe8a1; }

/* Modal */
#releaseFormContainer {
  display:none;
  position:fixed;
  top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.5);
  justify-content:center;
  align-items:center;
  z-index:1000;
}
#releaseFormContainer > div {
  background:white;
  padding:25px;
  border-radius:16px;
  width:90%;
  max-width:400px;
  box-shadow:0 12px 25px rgba(0,0,0,0.2);
}
#releaseForm input, #releaseForm textarea, #releaseForm select {
  width:100%;
  padding:10px;
  margin:8px 0;
  border-radius:8px;
  border:1px solid #ccc;
}
#releaseForm button {
  width:48%;
  padding:12px;
  border:none;
  border-radius:8px;
  font-size:16px;
  cursor:pointer;
}
#releaseForm button[type="submit"]{ background:#093d75; color:white; }
#releaseForm button[type="button"]{ background:#dc3545; color:white; }
</style>
</head>
<body>

<div class="navbar">
  <div style="display:flex; align-items:center; gap:10px;">
    <img src="bpldlogo.png" alt="Logo" style="width:40px; height:40px;">
    <h2>BUSINESS PERMIT AND LICENSE DEPARTMENT</h2>
    <h3>DASHBOARD</h3>
  </div>
  <button onclick="logout()">Logout</button>
</div>

<div class="dashboard-top">
  <div class="welcome">
    <h3>Welcome, <span id="name"></span></h3>
  </div>
  <div class="receiving">
    <button onclick="window.location='form.html'">Receiving Form</button>
  </div>
</div>

<div class="table-container">
  <h3>Pending Transactions</h3>
  <table id="pendingTable">
    <thead>
      <tr>
        <th>ID</th><th>NAME</th><th>DESCRIPTION</th><th>TRANSACTION</th><th>STATUS</th><th>REMARKS</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Release Modal -->
<div id="releaseFormContainer">
  <div>
    <form id="releaseForm">
      <input type="hidden" id="recordId">
      <label>NAME</label>
      <input type="text" id="nameField" readonly>
      <label>DESCRIPTION</label>
      <input type="text" id="descField" readonly>
      <label>TRANSACTION</label>
      <input type="text" id="transField" readonly>
      <label>STATUS</label>
      <select id="statusField" required>
        <option value="PENDING">PENDING</option>
        <option value="HOLD">HOLD</option>
        <option value="TRANSFER">TRANSFER</option>
        <option value="FINISHED">FINISHED</option>
        <option value="CANCEL">CANCEL</option>
      </select>
      <label>RELEASED BY</label>
      <input type="text" id="releasedBy" required>
      <label>REMARKS</label>
      <textarea id="remarks"></textarea>
      <div style="display:flex; justify-content:space-between;">
        <button type="submit">Release</button>
        <button type="button" onclick="closeReleaseForm()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbx1iqP0NWZ2HBdVOTzzyXbz7QyMLY24D6krKRuggm3cClCVrQfR4rTiBqwuMTZw_rpSaQ/exec";

/* ===== Display User Info ===== */
document.getElementById("name").innerText = (localStorage.getItem("fullname") || "Guest").toUpperCase();

function logout() {
  localStorage.clear();
  window.location.href = "index.html";
}

/* ===== Load Pending Transactions ===== */
async function loadPending() {
  try {
    const res = await fetch(scriptURL + "?action=listPending");
    if (!res.ok) throw new Error("Cannot fetch pending data. Check your Web App URL and deployment.");
    const data = await res.json();

    const tbody = document.querySelector("#pendingTable tbody");
    tbody.innerHTML = "";

    if (data.success && data.records.length > 0) {
      data.records.forEach(r => {
        const tr = document.createElement("tr");
        tr.className = "pending";
        tr.innerHTML = `
          <td>${r.id}</td>
          <td>${r.name.toUpperCase()}</td>
          <td>${r.description.toUpperCase()}</td>
          <td>${r.transaction.toUpperCase()}</td>
          <td>${r.status.toUpperCase()}</td>
          <td>${r.remarks ? r.remarks.toUpperCase() : ""}</td>
        `;
        tr.addEventListener("click", () => openReleaseForm(r, tr));
        tbody.appendChild(tr);
      });
    } else {
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">NO PENDING TRANSACTIONS</td></tr>`;
    }
  } catch (err) {
    alert("❌ ERROR LOADING PENDING TRANSACTIONS: " + err.message);
  }
}

/* ===== Open Release Modal ===== */
function openReleaseForm(record, row) {
  const modal = document.getElementById("releaseFormContainer");
  modal.style.display = "flex";

  document.getElementById("recordId").value = record.id;
  document.getElementById("nameField").value = record.name.toUpperCase();
  document.getElementById("descField").value = record.description.toUpperCase();
  document.getElementById("transField").value = record.transaction.toUpperCase();
  document.getElementById("statusField").value = record.status.toUpperCase();
  document.getElementById("releasedBy").value = (localStorage.getItem("fullname") || "").toUpperCase();
  document.getElementById("remarks").value = record.remarks ? record.remarks.toUpperCase() : "";
}

/* ===== Close Modal ===== */
function closeReleaseForm() {
  document.getElementById("releaseFormContainer").style.display = "none";
  document.getElementById("releaseForm").reset();
}

/* ===== Handle Release Submission ===== */
document.getElementById("releaseForm").addEventListener("submit", async e => {
  e.preventDefault();
  const recordId = document.getElementById("recordId").value;
  const releasedBy = document.getElementById("releasedBy").value;
  const remarks = document.getElementById("remarks").value;
  const status = document.getElementById("statusField").value;

  const formData = new FormData();
  formData.append("action", "release");
  formData.append("id", recordId);
  formData.append("releasedBy", releasedBy);
  formData.append("remarks", remarks);
  formData.append("status", status);

  try {
    const res = await fetch(scriptURL, { method: "POST", body: formData });
    const r = await res.json();

    if (r.success) {
      alert(`✅ TRANSACTION ${status.toUpperCase()} SUCCESSFULLY!`);
      closeReleaseForm();
      loadPending();
    } else {
      alert("❌ " + r.message);
    }
  } catch (err) {
    alert("❌ ERROR RELEASING TRANSACTION: " + err.message);
  }
});

/* ===== Initial Load ===== */
loadPending();
</script>
</body>
</html>
